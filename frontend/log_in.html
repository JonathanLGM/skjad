<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Banco - Login</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    .topbar { background: #004080; color: white; padding: 15px 30px; font-size: 1.5rem; }
    .container { background: white; padding: 30px; max-width: 400px; margin: 50px auto; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; background: #f0f0f0; border-radius: 5px 5px 0 0; }
    .tab.active { background: #004080; color: white; }
    form { display: none; flex-direction: column; }
    form.active { display: flex; }
    .input-box { margin-bottom: 15px; }
    .input-box input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .btn { padding: 10px; background: #004080; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .extra { margin-top: 10px; font-size: 0.9rem; }
    .extra a { color: #004080; text-decoration: none; }
  </style>
</head>
<body>
  <!-- Barra superior -->
  <header class="topbar">
    <div class="logo">BancaTerritorial</div>
  </header>

  <!-- Contenedor principal -->
  <main>
    <div class="container">
      <div class="tabs">
        <div class="tab active" onclick="showForm('login', event)">Iniciar Sesión</div>
        <div class="tab" onclick="showForm('register', event)">Registrarse</div>
      </div>

      <!-- Login -->
      <form id="login" class="active">
  <div class="input-box">
    <input type="text" id="loginUsername" placeholder="Usuario" required>
  </div>
  <div class="input-box">
    <input type="password" id="loginPassword" placeholder="Contraseña" required>
  </div>
  <button type="submit" class="btn">Ingresar</button>
  <div class="extra"><a href="#">¿Olvidaste tu contraseña?</a></div>
</form>

      <!-- Register -->
      <form id="register">
        <div class="input-box">
          <input type="text" id="regUsername" placeholder="Usuario" required>
        </div>
        <div class="input-box">
          <input type="password" id="regPassword" placeholder="Contraseña" required>
        </div>
        <div class="input-box">
          <input type="date" id="regFechaInicio" placeholder="Fecha Inicio" required>
        </div>
        <div class="input-box">
          <input type="number" id="regIdCliente" placeholder="ID Cliente" required>
        </div>
        <button type="submit" class="btn">Crear cuenta</button>
      </form>
    </div>
  </main>

  <script>

    // --- LOGIN ---
/*
  Script robusto para:
  1) POST /usuario/login      -> espera JSON o texto con JSON
  2) GET /usuario/cuenta-por-username/:username
  3) Guarda usuario + cuenta en localStorage
  4) GET /usuario/:id_usuario -> obtiene rol
  5) Redirige según rol a menuadmin.html o menu.html
  Maneja distintos formatos de respuesta (resultado, usuario, token, etc.)
*/

const loginForm = document.getElementById('login');

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;

  try {
    // 1) Login: POST a /usuario/login
    const res = await fetch('/usuario/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    // leer como texto por si el servidor mezcla HTML
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (parseErr) {
      console.error('Respuesta no JSON en /usuario/login:', text);
      throw new Error('El servidor no devolvió JSON válido al iniciar sesión');
    }

    if (!res.ok) {
      // Si el servidor manda { error: '...' } o { mensaje: '...' }
      const msg = data.error || data.mensaje || data.message || 'Error en login';
      throw new Error(msg);
    }

    // Guardar token si lo envían
    if (data.token) {
      try {
        localStorage.setItem('token', data.token);
      } catch (err) {
        console.warn('No se pudo guardar token en localStorage:', err);
      }
    }

    // 2) Obtener id_usuario robustamente (varias formas posibles)
    // Posibles ubicaciones: data.resultado.id_usuario, data.usuario.id_usuario, data.id_usuario, data.usuario.id
    const id_usuario =
      (data.resultado && (data.resultado.id_usuario || data.resultado.id)) ||
      (data.usuario && (data.usuario.id_usuario || data.usuario.id)) ||
      data.id_usuario ||
      data.id ||
      null;

    // Si el backend NO devuelve id_usuario en la respuesta del login,
    // intentaremos obtener el id desde otra ruta más tarde. Pero lo ideal es tenerlo.
    // Seguimos igualmente: consultamos la cuenta por username como tu flujo.
    // 3) Consultar cuenta por username
    const cuentaRes = await fetch(`/usuario/cuenta-por-username/${encodeURIComponent(username)}`, {
      headers: data.token ? { 'Authorization': 'Bearer ' + data.token } : {}
    });

    const cuentaText = await cuentaRes.text();
    let cuentaData;
    try {
      cuentaData = JSON.parse(cuentaText);
    } catch (err) {
      console.error('Respuesta no JSON en /usuario/cuenta-por-username:', cuentaText);
      throw new Error('No se pudo obtener la información de la cuenta (respuesta inválida)');
    }

    if (!cuentaRes.ok) {
      const msg = cuentaData.error || cuentaData.mensaje || 'Error al obtener cuenta';
      throw new Error(msg);
    }

    if (!cuentaData.resultado) {
      throw new Error('No se encontró cuenta para ese usuario');
    }

    // 4) Guardar usuario + cuenta en localStorage (mantener coherencia con tu flujo)
    const usuarioParaStorage = { username, cuenta: cuentaData.resultado };
    // si el login devolvió usuario completo, lo guardamos también
    if (data.usuario) usuarioParaStorage.info = data.usuario;
    try {
      localStorage.setItem('usuario', JSON.stringify(usuarioParaStorage));
    } catch (err) {
      console.warn('No se pudo guardar usuario en localStorage:', err);
    }

    // 5) Si no tenemos id_usuario, intentar obtenerlo por username con /usuario/por-username (opcional)
    // (si tu backend tiene esa ruta; si no, se usa el id obtenido del login)
    let final_id_usuario = id_usuario;

    if (!final_id_usuario) {
      // Intentar /usuario/por-username/:username o /usuario/username/:username — probamos una ruta razonable
      // Si no existen, este fetch fallará y seguimos (luego usaremos data.usuario.rol si viene en login)
      try {
        const tryPaths = [
          `/usuario/por-username/${encodeURIComponent(username)}`,
          `/usuario/username/${encodeURIComponent(username)}`
        ];
        for (const path of tryPaths) {
          const r = await fetch(path, {
            headers: data.token ? { 'Authorization': 'Bearer ' + data.token } : {}
          });
          if (!r.ok) continue;
          const t = await r.text();
          const parsed = JSON.parse(t);
          // buscar id en parsed.resultado o parsed.usuario
          const possibleId =
            (parsed.resultado && (parsed.resultado.id_usuario || parsed.resultado.id)) ||
            (parsed.usuario && (parsed.usuario.id_usuario || parsed.usuario.id)) ||
            parsed.id_usuario || parsed.id;
          if (possibleId) {
            final_id_usuario = possibleId;
            break;
          }
        }
      } catch (err) {
        // No hacemos nada; puede no existir esa ruta
        console.info('No se obtuvo id por rutas alternativas (no es crítico si ya tenemos rol):', err);
      }
    }

    // 6) Obtener rol: priorizamos lo que venga en data (login), sino pedimos /usuario/:id
    let rol = null;
    if (data.usuario && (data.usuario.rol || data.usuario.role)) {
      rol = data.usuario.rol || data.usuario.role;
    }

    if (!rol && final_id_usuario) {
      // pedir /usuario/:id
      const usuarioRes = await fetch(`/usuario/${final_id_usuario}`, {
        headers: data.token ? { 'Authorization': 'Bearer ' + data.token } : {}
      });
      const usuarioText = await usuarioRes.text();
      let usuarioJson;
      try {
        usuarioJson = JSON.parse(usuarioText);
      } catch {
        console.error('/usuario/:id devolvió no-JSON:', usuarioText);
        throw new Error('No se pudo leer la información del usuario para saber el rol');
      }
      if (!usuarioRes.ok) {
        const msg = usuarioJson.error || usuarioJson.mensaje || 'Error al obtener usuario';
        throw new Error(msg);
      }
      // formato: usuarioJson.resultado.rol o usuarioJson.resultado.role o usuarioJson.usuario.rol
      rol = (usuarioJson.resultado && (usuarioJson.resultado.rol || usuarioJson.resultado.role)) ||
            (usuarioJson.usuario && (usuarioJson.usuario.rol || usuarioJson.usuario.role)) ||
            usuarioJson.rol || usuarioJson.role || null;
    }

    // 7) Si aún no tenemos rol, podemos usar un fallback: redirigir a menu por defecto
    if (!rol) {
      console.warn('No se pudo determinar rol del usuario. Redirigiendo a menu por defecto.');
      window.location.href = 'menu.html';
      return;
    }

    // 8) Redirección final
    if (rol === 'admin' || rol === 'ADMIN' || rol === 'Administrador' || rol === 'administrador') {
      window.location.href = 'menuadmin.html';
    } else {
      window.location.href = 'menu.html';
    }

  } catch (err) {
    // Mostrar mensaje claro al usuario
    alert('Error: ' + (err.message || err));
    console.error('Error en flujo de login:', err);
  }
});
    // --- REGISTER ---
    const registerForm = document.getElementById('register');
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const usuarioData = {
        username: document.getElementById('regUsername').value,
        password: document.getElementById('regPassword').value,
        fecha_inicio: document.getElementById('regFechaInicio').value,
        id_cliente: parseInt(document.getElementById('regIdCliente').value)
      };

      try {
        const res = await fetch('/usuario/registrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(usuarioData)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.mensaje || 'Error al registrar');

        alert(data.mensaje); // Registro exitoso
        registerForm.reset();
        showForm('login', { currentTarget: document.querySelector('.tab') });
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });
  </script>
</body>
</html>
